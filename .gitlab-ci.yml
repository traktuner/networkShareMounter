# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
#include:
#- template: Security/Secret-Detection.gitlab-ci.yml

stages:
  - test
  - beta
  - build
  - upload
  - release
#  - test
#  - archive
#  - deploy

variables:
  LC_ALL: "en_US.UTF-8"
  LANG: "en_US.UTF-8"
  PACKAGE_VERSION: "2.0.0"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/networksharemounter/${PACKAGE_VERSION}"

before_script:
  - cp /Users/autopkg/dev/networkShareMounter/.env.default .
#  - gem install bundler
#  - pod install

beta_build:
  dependencies: []
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - fastlane beta
  artifacts:
    paths:
      - swiftlint.result.json
      - build/NetworkShareMounterBeta.dmg
    expire_in: 1 hour
  tags:
    - fastlane
    - xcode

deploy_build:
  dependencies: []
  stage: build
  rules:
  - if: $CI_COMMIT_TAG
  script:
    - fastlane releae
  artifacts:
    paths:
      - swiftlint.result.json
      - build/NetworkShareMounter.dmg
    expire_in: 1 hour
  tags:
    - fastlane
    - xcode
  only:
      - /^release-.*$/
      - master

upload:
  stage: upload
  - if: $CI_COMMIT_TAG
  script:
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file build/NetworkShareMounteBeta.dmg ${PACKAGE_REGISTRY_URL}/NetworkShareMounterBeta.dmg

release:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
    /usr/local/bin/release-cli create --name "Release $CI_COMMIT_TAG" --tag-name $CI_COMMIT_TAG \
      --assets-link "{\"name\":\"NetworkShareMounterBeta.dmg\",\"url\":\"${PACKAGE_REGISTRY_URL}/NetworkShareMounterBeta.dmg\"}"

  
