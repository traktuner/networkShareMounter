# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

skip_docs

# git url of match
@match_git_url = ENV["MATCH_GIT_URL"]

default_platform(:mac)

platform :mac do
  desc "Description of what the lane does"
  lane :custom_lane do
    # add actions here: https://docs.fastlane.tools/actions
  end
end

lane :setupCI do
  desc "Setup the keychain and match to work with CI"
  setup_ci
end

lane :getbundleid do
  desc "gets bundleid from the xcode project files"
  get_product_bundle_id(project_filepath: 'networkShareMounter.xcodeproj', scheme: 'NetworkShareMounter')
end

lane :getappversion do
  desc "gets the version of the app. It first looks in the plist and then for '$(MARKETING_VERSION)'"
  get_version_number(xcodeproj: "networkShareMounter.xcodeproj",target: "Network Share Mounter")  
end

lane :getlatestag do
  desc "gets the latest git tag. This tag is used to set the version number of the package"
  tags = git_tags(limit: 1)
  tags.join()
end

lane :sentryUpload do
  desc "send dSYM and maybe other data to our sentry instance"
  sentry_debug_files_upload(
    project_slug: "network-share-mounter",
  )
end

lane :sync_certificates do
  desc "Sync certificates using match"
  # Setup App Store Connect API Key
  app_store_connect_api_key(
    is_key_content_base64: true
  )
  
  # Sync certificates for Developer ID
  match(
    type: "developer_id",
    readonly: is_ci,
    #readonly: true,
    platform: "macos",
    app_identifier: 'de.fau.rrze.NetworkShareMounter',
    additional_cert_types: ["mac_installer_distribution"]
  )
end

lane :commonTasks do
  desc "perform some commont build tasks"
  id = getbundleid
  tag = getlatestag
  
  # Setup CI if running in CI environment
  setupCI if is_ci
  
  # Run SwiftLint
  swiftlint(
    mode: :lint,
    output_file: "swiftlint.result",
    config_file: ".swiftlint-ci.yml",
    files: [
      # Your file list here
      "Network Share Mounter/preferences/config.swift",
      # ... other files
    ],
    raise_if_swiftlint_error: true,
    ignore_exit_status: true
  )
  
  # Sync certificates
  sync_certificates
  
  # Build the app
  gym(
    scheme: "networkShareMounter",
    output_directory: "build/",
    export_method: "developer-id",
    installer_cert_name: "Universitaet Erlangen-Nuernberg RRZE (C8F68RFW4L)"
  )
end

lane :build do
  begin
    commonTasks
  end
end

lane :create_package do |options|
  appversion = getappversion
  build_type = options[:type] || ""
  suffix = build_type.empty? ? "" : "#{build_type}-"
  
  desc "Create DMG image"
  dmg(
    path: "build/Network Share Mounter.app",
    output_path: "build/NetworkShareMounter-#{suffix}#{appversion}.dmg",
    volume_name: "NetworkShareMounter#{build_type.empty? ? "" : "-#{build_type}"}",
    size: 10
  )
  
  desc "creating .pkg file"
  signing_id = ENV["SIGNING_ID"]
  output = sh("productbuild", 
            "--sign",  "#{signing_id}", 
            "--scripts", "../pkgscripts", 
            "--version", "#{appversion}", 
            "--component", "../build/Network\ Share\ Mounter.app", 
            "/Applications", 
            "../build/NetworkShareMounter-#{suffix}#{appversion}.pkg")

  desc "Notarize dmg"
  notarize(
    package: "build/NetworkShareMounter-#{suffix}#{appversion}.dmg", 
    bundle_id: "de.fau.rrze.NetworkShareMounter", 
    username: "rrze-apple-entwickler@fau.de"
  )
  
  desc "Notarize pkg"
  notarize(
    package: "build/NetworkShareMounter-#{suffix}#{appversion}.pkg", 
    bundle_id: "de.fau.rrze.NetworkShareMounter", 
    username: "rrze-apple-entwickler@fau.de"
  )
end

lane :testbuild do
  begin
    desc "increment Xcodes build number"
    increment_build_number(
      xcodeproj: "networkShareMounter.xcodeproj"
    )
    build
    create_package(type: "Test")
  rescue => exception
    on_error(exception)
  end
end

lane :alpha do
  begin
    desc "increment Xcodes build number"
    increment_build_number(
      xcodeproj: "networkShareMounter.xcodeproj"
    )
    build
    create_package(type: "Alpha")
    sentryUpload
  rescue => exception
    on_error(exception)
  end
end

lane :beta do
  begin
    desc "increment Xcodes build number"
    increment_build_number(
      xcodeproj: "networkShareMounter.xcodeproj"
    )
    build
    create_package(type: "Beta")
    sentryUpload
  rescue => exception
    on_error(exception)
  end
end

lane :release do
  begin
    desc "increment Xcodes build number"
    increment_build_number(
      xcodeproj: "networkShareMounter.xcodeproj"
    )
    build
    create_package
    sentryUpload
  rescue => exception
    on_error(exception)
  end
end

# generates the command-line networkShareMounter app
lane :runbuild do
  id = getbundleid
  tag = getlatestag
  signing_id = ENV["SIGNING_ID"]
  output = sh("../build.sh", "#{id}", "#{tag}", "#{signing_id}")
end

def on_error(exception)
  UI.error("An error occurred: #{exception}")
end
